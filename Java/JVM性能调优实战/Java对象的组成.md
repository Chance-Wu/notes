> 对象在内存中存储的结构分为3部分：
>
> - ==对象头==（Header）
>   - MarkWord    4字节
>   - Class对象指针    4字节
> - ==实例数据==（Instance Data）    实际数据大小
> - ==对齐填充==（Padding，可选）    按8字节对齐

#### 1. 对象头

1. ==Markword==（标记字段）：用于*<u>存储对象自身的运行时数据</u>*。标记字段被设计成一个非固定的数据结构以便在极小的空间内存储尽量多的信息，它会根据对象的状态复用自己的存储空间。如果是数组的话，还需要一块徐裕存放数组大小。（因为没办法从元数据确认数组大小，所以要存储到对象头的MarkWorld中）
   - 哈希码
   - GC分代年龄
   - 锁状态标志
   - 线程持有的锁
   - 偏向线程ID
   - 偏向时间戳等

MarkWord是根据对下哪个<img src="https://tva1.sinaimg.cn/large/0081Kckwgy1gke97qppowj30fa077mxc.jpg" style="zoom:120%">

<img src="https://tva1.sinaimg.cn/large/0081Kckwgy1gke9w9nmmdj30fa077wen.jpg" style="zoom:120%">

2. ==klass Pointer==（类型指针）：即指向当前对象的类的元数据的指针，*<u>虚拟机通过这个指针来确定这个对象是哪个类的实例</u>*。并不是所有的虚拟机实现都必须在对象数据上保留类型指针，换句话说查找对象的元数据信息并不一定要经过对象本身。

3. ==数组长度==（只有数组对象有）：如果对象是一个数组, 那在对象头中还必须有一块数据用于记录数组长度。（虚拟机可以通过普通Java对象的元数据信息确定Java对象的大小，但是从数组的元数据中无法确定数组的大小。）

#### 2. 实例数据

> 实例数据部分是对象真正存储的有效信息，也就是我们在程序代码里面所定义的各种类型的字段内容，无论是从父类继承下来的，还是在子类中定义的都需要记录下来。 这部分的存储顺序会受到虚拟机分配策略参数（FieldsAllocationStyle）和字段在Java源码中定义顺序的影响。

> Tips：HotSpot虚拟机默认的分配策略为longs/doubles、ints、shorts/chars、bytes/booleans、oops（Ordinary Object Pointers），从分配策略中可以看出，相同宽度的字段总是被分配到一起。在满足这个前提条件的情况下，在父类中定义的变量会出现在子类之前。如果 CompactFields参数值为true（默认为true），那子类之中较窄的变量也可能会插入到父类变量的空隙之中。

#### 3. 对齐填充

> 这部分不是必须的。由于HotSpot VM的==自动内存管理系统要求对象起始地址必须是8字节的整数倍==，换句话说就是对象的大小必须是8字节的整数倍。
>
> 对象头正好是8字节的倍数（1倍或者2倍），因此当对象实例数据部分没有对齐的话，就需要通过对齐填充来补全。

#### 4. 对象的创建过程

> 在虚拟机中，对象（仅限于普通Java对象，不包括数组和Class对象等）的创建是怎样的？

> 以下分析虚拟机遇到new指令时的操作：
>
> 一个对象的存储涉及内存的三部分：方法栈（存储指针）、方法区（存储类信息、常量、静态变量）、堆（存储对象的实例数据）

> 创建过程：
>
> 1. new 类名
> 2. 根据new的参数在常量池中定位一个类的符号引用
> 3. 如果没有找到这个符号引用，说明类还没有被加载，则进行类的加载、解析和初始化
> 4. 虚拟机为对象分配内存（位于堆中）
> 5. 将分配的内存初始化为零值（不包括对象头）
> 6. 调用对象的<init>方法
>
> 其中关于“对象的引用”有两种实现方式：
>
> 1. ==通过句柄实现==
>
>    Java堆中将会划分出一块内存来作为句柄池，reference中存储的就是对象的句柄地址，而句柄中包含了对象实例数据与类型数据各自的具体地址信息。
>
> <img src="https://tva1.sinaimg.cn/large/0081Kckwgy1gkf6s2l29fj310o0lk3z3.jpg" style="zoom:60%">
>
> 2. 直接指针实现
>
>    Java堆对象的布局中必须考虑到如何放置访问类类型数据的相关信息，而reference中存储的直接就是对象地址。
>
> <img src="https://tva1.sinaimg.cn/large/0081Kckwgy1gkf6wnton3j310o0lkmxn.jpg" style="60%">

#### 5. 举例

> 在Hotspot JVM中，32bit机器下，Integer对象的大小是int的几倍？
>
> int占用4字节。Integer的结构如下：
>
> <img src="https://tva1.sinaimg.cn/large/0081Kckwgy1gkf8bjryzvj30k10aaq2u.jpg" style="zoom:80%">
>
> 由此得出Integer对象的大小是16字节，是原生的int类型的4倍。

> Tips：注意==数组的内存结构==和普通对象的内存结构稍微不同，因为数据有一个长度length字段，所以在对象头后面还==多了一个int类型的length字段==，占4个字节。
>
> <img src="https://tva1.sinaimg.cn/large/0081Kckwgy1gkf8jik1dsj30ka0csq2x.jpg" style="zoom:80%">