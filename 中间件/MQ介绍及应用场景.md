#### 什么是消息队列

队列是一种==先进先出==的数据结构。

<img src="https://tva1.sinaimg.cn/large/008eGmZEgy1gobtqttz8vj30ie03raa3.jpg" style="zoom:80%">

在Java里面，已经实现了不少的队列了：

<img src="https://tva1.sinaimg.cn/large/008eGmZEgy1gobtuq9xpyj30hk14mdiw.jpg" style="zoom:60%">

既然这样，为什么还需要消息队列这种中间件呢？

消息队列可以简单理解为：==把要传输的数据放在队列中==。

#### 1. 为什么要用MQ（Message Queue）

>message queue
>
>消息队列是一种“先进先出”的数据结构。
>
><img src="https://tva1.sinaimg.cn/large/008eGmZEgy1gnbg5d0gvqj30tu05w0tb.jpg" style="zoom:80%">
>
>主要应用场景包括以下3个方面：
>
>- ==应用解耦==（由同步调用变为异步调用）
>
>- ==流量削峰==
>
>- ==数据分发==
>

#### 2. MQ优点和缺点

>优点：解耦、削峰、数据分发
>
>缺点：
>
>- 系统可用性降低（系统引入的外部依赖越多，系统稳定性越差。一旦MQ宕机，就会对业务造成影响。）==如何保证MQ高可用？==
>- 系统复杂度提高（MQ的加入大大增加了系统的复杂度，以前系统间是同步的远程调用，现在是通过MQ进行异步调用。）==如何保证消息没有被重复消费？怎么处理消息丢失情况？怎么保证消息传递的顺序性？==
>- 一致性问题（A系统处理完业务，通过MQ给B、C、D三个系统发送消息数据，如果B系统、C系统处理成功，D处理失败。）==如何保证消息数据处理的一致性？==

#### 3. MQ比较选型

|               | ActiveMQ                       | RabbitMQ                                                     | RocketMQ                 | kafka                                                        |
| ------------- | ------------------------------ | ------------------------------------------------------------ | ------------------------ | ------------------------------------------------------------ |
| 开发语言      | java                           | erlang                                                       | ==java==                 | scala                                                        |
| 单机吞吐量TPS | 万级                           | 万级                                                         | 10万级                   | 10万级                                                       |
| 时效性        | ms级                           | ==us级==                                                     | ms级                     | ms级以内                                                     |
| 可用性        | 高（主从架构）                 | 高（主从架构）                                               | ==非常高（分布式架构）== | 非常高（分布式架构）                                         |
| 功能性        | 有较多的文档；各种协议支持较好 | 基于erlang开发，所以并发能力很强，性能好，延时低；管理界面丰富 | MQ功能比较完备，扩展性佳 | 只支持主要的MQ功能，像一些消息查询，消息回溯等功能没有提供，毕竟是为大数据准备的，在大数据领域应用广 |

#### 4. 应用场景

##### 4.1 异步处理

> 场景说明：用户==注册==后，需要发==注册邮件==和==注册短信==，有以下3种做法：

**串行方式**

将注册信息写入数据库后，发送注册邮件，再发送注册短信，以上三个任务全部完成后才返回给客户端。这有一个问题是，邮件，短信并不是必须的，它只是一个通知，而这种做法让客户端等待没有必要等待的东西。

<img src="https://tva1.sinaimg.cn/large/008eGmZEgy1gob6nvwzuij30r8069q31.jpg" style="zoom:80%">

**并行方式**

将注册信息写入数据库后，发送邮件的同时，发送短信，以上三个任务完成后，返回给客户端，并行的方式能提高处理的时间。

<img src="https://tva1.sinaimg.cn/large/008eGmZEgy1gob6qj9husj30mz0ant8u.jpg" style="zoom:80%">

假设三个业务节点分别使用50ms，串行方式使用时间150ms，并行使用时间100ms。虽然并行已经提高的处理时间，但是，前面说过，邮件和短信对我正常的使用网站没有任何影响，客户端没有必要等着其发送完成才显示注册成功，应该是写入数据库后就返回。

**消息队列**

引入消息队列后，==把不是必须的业务逻辑（发送邮件，短信）异步处理==。

<img src="https://tva1.sinaimg.cn/large/008eGmZEgy1gob76v26u8j30sm083aa9.jpg" style="zoom:80%">

由此可以看出，引出消息队列后，用户的响应时间就等于写入数据库的时间+写入消息队列的时间（可以忽略不计），引入消息队列后处理后，响应时间大大缩减。

##### 4.2 应用解耦

> 场景：双11购物节，用户下单后，订单系统需要通知库存系统，传统的做法就是订单系统调用库存系统的接口。
>
> <img src="https://tva1.sinaimg.cn/large/008eGmZEgy1gob81czsy0j30ct02u3yb.jpg" style="zoom:80%">
>
> 这种做法有一个缺点：
>
> - 当库存系统出现故障时，订单就会失败。
> - 订单系统和库存系统高耦合。
>
> 解决办法：引入消息队列
>
> <img src="https://tva1.sinaimg.cn/large/008eGmZEgy1gob8ax0lktj30fh06qwee.jpg" style="zoom:80%">
>
> - 订单系统：用户下单后，订单系统完成持久化处理，将消息写入消息队列，返回用户订单成功。
> - 库存系统：订阅下单的消息，获取下单消息，进行库操作。就算库存系统出现故障，消息队列也能保证消息的可靠投递，不会导致消息丢失。

##### 4.3 流量削峰

>场景：秒杀活动，一般会应为流量过大，导致整个应用挂掉，为了解决这个问题，==一般在应用前端加入消息发队列==。
>
>作用：
>
>1. 可以控制活动人数，超过此一定阈值的订单直接丢弃
>2. 可以缓解短时间的高流量压垮应用
>
><img src="https://tva1.sinaimg.cn/large/008eGmZEgy1gob8ha7xd9j30h4034glj.jpg" style="zoom:80%">
>
>- 用户请求，服务器收到之后，首先写入消息队列，加入消息队列长度超过最大值，则直接抛弃用户请求或跳转到错误页面。
>- 秒杀业务根据消息队列中的请求信息，再做后续处理。

