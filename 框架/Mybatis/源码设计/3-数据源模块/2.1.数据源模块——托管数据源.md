==Java 命名与目录接口（Java Naming and Directory Interface）==

#### JNDI数据源

---

Mybatis中专门提供的一个数据源工厂——`JndiDataSourceFactory`，与事务模块中`MANAGED类型的事务`一致，也属于托管型，它用于在使用诸如与Spring容器整合的场合，这时为了便于使这些外部定义的数据源整合到Mybatis的环境中，就需要使用这个JNDI数据源工厂来进行获取。

>这里只定义了数据源工厂，真正的数据源由外部来提供，这还是纯种的抽象工厂模式。
>
>```java
>/**
> * 这个数据源的实现是为了使用如Spring或应用服务器这类容器，容器可以集中或在外部配置数据源，然后放置一个JNDI上下文的引用
> */
>public class JndiDataSourceFactory implements DataSourceFactory {
>
>  public static final String INITIAL_CONTEXT = "initial_context";
>  public static final String DATA_SOURCE = "data_source";
>  // 和其他数据源相似，可以通过名为"env."的前缀直接向初始时上下文发送属性
>  public static final String ENV_PREFIX = "env.";
>
>  private DataSource dataSource;
>
>  @Override
>  public void setProperties(Properties properties) {
>    try {
>      InitialContext initCtx;
>      Properties env = getEnvProperties(properties);
>      if (env == null) {
>        initCtx = new InitialContext();
>      } else {
>        initCtx = new InitialContext(env);
>      }
>
>      if (properties.containsKey(INITIAL_CONTEXT) && properties.containsKey(DATA_SOURCE)) {
>        Context ctx = (Context) initCtx.lookup(properties.getProperty(INITIAL_CONTEXT));
>        dataSource = (DataSource) ctx.lookup(properties.getProperty(DATA_SOURCE));
>      } else if (properties.containsKey(DATA_SOURCE)) {
>        dataSource = (DataSource) initCtx.lookup(properties.getProperty(DATA_SOURCE));
>      }
>
>    } catch (NamingException e) {
>      throw new DataSourceException("There was an error configuring JndiDataSourceTransactionPool. Cause: " + e, e);
>    }
>  }
>
>  @Override
>  public DataSource getDataSource() {
>    return dataSource;
>  }
>
>  private static Properties getEnvProperties(Properties allProps) {
>    final String PREFIX = ENV_PREFIX;
>    Properties contextProperties = null;
>    for (Entry<Object, Object> entry : allProps.entrySet()) {
>      String key = (String) entry.getKey();
>      String value = (String) entry.getValue();
>      // 和其他数据源配置相似，可以通过名为"env."的前缀直接向初始时上下文发送属性
>      if (key.startsWith(PREFIX)) {
>        if (contextProperties == null) {
>          contextProperties = new Properties();
>        }
>        contextProperties.put(key.substring(PREFIX.length()), value);
>      }
>    }
>    return contextProperties;
>  }
>
>}
>```
>
>- JNDI数据源工厂类定了一个继承自DataSourceFactory的获取数据源的方法`getDataSource()方法`，==用于获取外部创建的数据源实例==。
>- 设置属性的方法，与非池型数据源工厂中类似，==JNDI数据源也可以通过前缀的方式设置一些数据源的属性来传递到数据源中==，用来设置数据源的基本信息。
>- JNDI数据源就是通过在外部数据源上覆盖一个上下文，即==将数据源添加到某个上下文中，将这个上下文传递到工厂，由工厂从上下文中获取这个数据源，并通过getDataSource()被获取==。
>
>针对Mybatis整合的程序开发，只要针对这个工厂来开发就行了。

至此，`数据源模块`与之前解析的`事务模块`为组装`Environment环境`的两个重要的唯二的模块，而Environment又是构建Configuration配置类的首要模块。

