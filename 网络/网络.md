#### 1. OSI模型

> ==OSI参考模型==（`Open System Interconnect`—开放式系统互联）
>
> <img src="https://tva1.sinaimg.cn/large/008eGmZEgy1gn26wrkt4gj30ra0esmyj.jpg" style="zoom:60%">
>
> 1. **物理层**：主要定义物理设备标准，如网线的接口类型、光纤的接口类型、各种传输介质的传输速率等。它的主要作用是==传输比特流==（就是由 1、0 转化为电流强弱来进行传输,到达目的地后在转化为1、0，也就是我们常说的模数转换与数模转换）。这一层的数据叫做比特。
>
> 2. **数据链路层**：主要将从物理层接收的数据进行 ==MAC 地址（网卡的地址）的封装与解封装==。常把这一层的数据叫做==帧==。在这一层工作的设备是交换机，数据通过交换机来传输。
>
> 3. **网络层**：主要将从下层接收到的数据进行 ==IP 地址（例 192.168.0.1)的封装与解封装==。在这一层工作的设备是路由器，常把这一层的数据叫做数据包。
>
> 4. **传输层**：定义了一些==传输数据的协议和端口号==（WWW 端口 80 等），如：
>    - TCP—传输控制协议，传输效率低，可靠性强，用于传输可靠性要求高，数据量大的数据。
>    - UDP—用户数据报协议，与 TCP 特性恰恰相反，用于传输可靠性要求不高，数据量小的数据，如 QQ 聊天数据就是通过这种方式传输的。 主要是将从下层接收的数据进行分段进行传输，到达目的地址后在进行重组。常常把这一层数据叫做段。
>
> 5. **会话层**：通过传输层（端口号：传输端口与接收端口）==建立数据传输的通路==。主要在你的系统之间发起会话或或者接受会话请求（设备之间需要互相认识可以是 IP 也可以是 MAC 或者是主机名）
>
> 6. **表示层**：主要是进行对接收的数据进行==解释、加密与解密、压缩与解压缩==等（也就是把计算机能够识别的东西转换成人能够能识别的东西（如图片、声音等））
>
> 7. **应用层**：主要是一些==终端的应用==，比如说FTP（各种文件下载），WEB（IE浏览），QQ之类的（你就把它理解成我们在电脑屏幕上可以看到的东西．就 是终端应用）。
>
> <img src="https://tva1.sinaimg.cn/large/008eGmZEgy1gn27e83fxoj30ye0madl3.jpg" style="zoom:50%">

#### 2. TCP/IP模型

><img src="https://tva1.sinaimg.cn/large/008eGmZEgy1gn27jbx561j30h00av0ta.jpg" style="zoom:100%">

>TCP/IP协议是指因特网整个TCP/IP协议簇。从协议分层模型来讲，分为：
>
>- 网络接口层
>- 网络层
>- 传输层
>- 应用层
>
><img src="https://tva1.sinaimg.cn/large/008eGmZEgy1gn27ohl20uj30ui0hoacu.jpg" style="zoom:50%">

##### 2.1 网络访问层

>该层在TCP/IP参考模型中并没有详细描述，只是指出==主机必须使用某种协议与网络连接==。

##### 2.2 网络层

>整个结构的关键部分，其功能是使主机可以把分组发往任何网络，并使分组独立地传向目标。这些分组可能经由不同的网络，到达的顺序和发送的顺序也可能不同。高层如果需要顺序收发，那么就必须自行处理对分组的排序。==互联网层使用因特网协议—IP==。

##### 2.3 传输层

>该层使源端和目的端机器上的对等实体可以进行会话。在这一层定义了两个==端到端的协议==：
>
>- ==传输控制协议(TCP==，Transmission Control Protocol)：面向连接的协议，它提供可靠的报文传输和对上层应用的连接服务。为此，除了基本的数据传输外，它还有可靠性保证、流量控制、多路复用、优先权和安全性控制等功能。
>- ==用户数据报协议(UDP==，User Datagram Protocol)：面向无连接的不可靠传输的协议，主要用于不需要 TCP 的排序和流量控制等功能的应用程序。

##### 2.4 应用层

>该层包含所有的高层协议，包括：
>
>- 虚拟终端协议TELNET（TELecommunications NETwork)
>- 文件传输协议FTP（File Transfer Protocol)
>- 电子邮件传输协议SMTP（Simple Mail Transfer Protocol)
>- 域名服务DNS（Domain Name Service)
>- 网上新闻传输协议NNTP（Net News Transfer Protocol)
>- ==超文本传送协议==`HTTP`（HyperText Transfer Protocol)

#### 3. TCP三次握手/四次挥手

>TCP在传输之前会进行三次沟通，传输玩数据断开的时候要进行四次沟通。

##### 3.1 数据包说明

><img src="https://tva1.sinaimg.cn/large/008eGmZEgy1gn3hz7gu6gj31180jcq6b.jpg" style="zoom:80%">
>
>**源端口和目的端口字段**
>
>- TCP源端口（Source Port）：源计算机上的应用程序的端口号，占 16 位。
>- TCP目的端口（Destination Port）：目标计算机的应用程序端口号，占 16 位。
>
>**序列号字段**
>
>CP序列号（Sequence Number）：占 32 位。它表示本报文段所发送数据的第一个字节的编号。在 TCP 连接中，所传送的字节流的每一个字节都会按顺序编号。当SYN标记不为1时，这是当前数据分段第一个字母的序列号；如果SYN的值是1时，这个字段的值就是初始序列值（ISN），用于对序列号进行同步。这时，第一个字节的序列号比这个字段的值大1，也就是ISN加1。
>
>**确认号字段**
>
>TCP 确认号（Acknowledgment Number，ACK Number）：占 32 位。它表示接收方期望收到发送方下一个报文段的第一个字节数据的编号。其值是接收计算机即将接收到的下一个序列号，也就是下一个接收到的字节的序列号加1。
>
>**数据偏移字段**
>
>TCP 首部长度（Header Length）：数据偏移是指数据段中的“数据”部分起始处距离 TCP 数据段起始处的字节偏移量，占 4 位。其实这里的“数据偏移”也是在确定 TCP 数据段头部分的长度，告诉接收端的应用程序，数据从何处开始。
>
>**保留字段**
>
>保留（Reserved）：占 4 位。为 TCP 将来的发展预留空间，目前必须全部为 0。
>
>**标志位字段**
>
>- CWR（Congestion Window Reduce）：拥塞窗口减少标志，用来表明它接收到了设置 ECE 标志的 TCP 包。并且，发送方收到消息之后，通过减小发送窗口的大小来降低发送速率。
>- ECE（ECN Echo）：用来在 TCP 三次握手时表明一个 TCP 端是具备 ECN 功能的。在数据传输过程中，它也用来表明接收到的 TCP 包的 IP 头部的 ECN 被设置为 11，即网络线路拥堵。
>- URG（Urgent）：表示本报文段中发送的数据是否包含紧急数据。URG=1 时表示有紧急数据。当 URG=1 时，后面的紧急指针字段才有效。
>- ACK：表示前面的确认号字段是否有效。ACK=1 时表示有效。只有当 ACK=1 时，前面的确认号字段才有效。TCP 规定，连接建立后，ACK 必须为 1。
>- PSH（Push）：告诉对方收到该报文段后是否立即把数据推送给上层。如果值为 1，表示应当立即把数据提交给上层，而不是缓存起来。
>- RST：表示是否重置连接。如果 RST=1，说明 TCP 连接出现了严重错误（如主机崩溃），必须释放连接，然后再重新建立连接。
>- SYN：在建立连接时使用，用来同步序号。当 SYN=1，ACK=0 时，表示这是一个请求建立连接的报文段；当 SYN=1，ACK=1 时，表示对方同意建立连接。SYN=1 时，说明这是一个请求建立连接或同意建立连接的报文。只有在前两次握手中 SYN 才为 1。
>- FIN：标记数据是否发送完毕。如果 FIN=1，表示数据已经发送完成，可以释放连接。
>
>**窗口大小字段**
>
>窗口大小（Window Size）：占 16 位。它表示从 Ack Number 开始还可以接收多少字节的数据量，也表示当前接收端的接收窗口还有多少剩余空间。该字段可以用于 TCP 的流量控制。
>
>**TCP 校验和字段**
>
>校验位（TCP Checksum）：占 16 位。它用于确认传输的数据是否有损坏。发送端基于数据内容校验生成一个数值，接收端根据接收的数据校验生成一个值。两个值必须相同，才能证明数据是有效的。如果两个值不同，则丢掉这个数据包。Checksum 是根据伪头 + TCP 头 + TCP 数据三部分进行计算的。
>
>**紧急指针字段**
>
>紧急指针（Urgent Pointer）：仅当前面的 URG 控制位为 1 时才有意义。它指出本数据段中为紧急数据的字节数，占 16 位。当所有紧急数据处理完后，TCP 就会告诉应用程序恢复到正常操作。即使当前窗口大小为 0，也是可以发送紧急数据的，因为紧急数据无须缓存。
>
>**可选项字段**
>
>选项（Option）：长度不定，但长度必须是 32bits 的整数倍。
>
><img src="https://tva1.sinaimg.cn/large/008eGmZEgy1gn3i96udtmj310u0u040b.jpg" style="zoom:60%">

##### 3.2 三次握手

>- 第一次握手：主机 A 发送位码为 ==syn＝1==，随机产生 seq number=1234567 的数据包到服务器，主机 B 由 SYN=1 知道，A 要求建立联机；
>
>- 第二次握手：主机 B 收到请求后要确认联机信息，向 A 发 送 ack number=( 主 机 A 的seq+1)，syn=1，==ack=1==,随机产生 seq=7654321 的包
>
>- 第三次握手：主机 A 收到后==检查 ack number 是否正确==，即第一次发送的 seq number+1，==以及位码ack 是否为 1==，若正确，主机 A 会再发送 ack number=(主机 B 的 seq+1)，ack=1，主机 B 收到后确认seq值与ack=1则连接建立成功。
>
><img src="https://tva1.sinaimg.cn/large/008eGmZEgy1gn3shnzzmej31300pegnp.jpg" style="zoom:50%">

##### 3.3 四次挥手

>TCP 断开连接要进行四次。这是由于 TCP 的半关闭造成的。因为 TCP 连接是全双工的(即数据可在两个方向上同时传递)所以进行关闭时==每个方向上都要单独进行关闭==。这个单方向的关闭就叫半关闭。当一方完成它的数据发送任务，就发送一个 FIN 来向另一方通告将要终止这个方向的连接。
>
>1. 关闭客户端到服务器的连接：==首先客户端 A 发送一个 FIN，用来关闭客户到服务器的数据传送，然后等待服务器的确认==。其中终止标志位 FIN=1，序列号 seq=u
>
>2. 服务器收到这个 FIN，它发回一个 ACK，==确认号 ack 为收到的序号加 1==。 
>
>3.  关闭服务器到客户端的连接：也是发送一个 FIN 给客户端。
>
>4. 客户段收到 FIN 后，并发回一个 ACK 报文确认，并将确认序号 seq 设置为收到序号加 1。
>
><img src="https://tva1.sinaimg.cn/large/008eGmZEgy1gn3svd7tbmj30zi0pqmzl.jpg" style="zoom:60%">
>
>首先进行关闭的一方将执行主动关闭，而另一方执行被动关闭。主机 A 发送 FIN 后，进入终止等待状态，服务器 B 收到主机 A 连接释放报文段后，就立即给主机 A 发送确认，然后服务器 B 就进入 close-wait 状态，此时 TCP 服务器进程就通知高层应用进程，因而从 A 到 B 的连接就释放了。此时是“半关闭”状态。即 A 不可以发送给B，但是 B 可以发送给 A。此时，若 B 没有数据报要发送给 A 了，其应用进程就通知 TCP 释放连接，然后发送给 A 连接释放报文段，并等待确认。A 发送确认后，进入 time-wait，注意，此时 TCP 连接还没有释放掉，然后经过时间等待计时器设置的 2MSL 后，A 才进入到close 状态。

#### 4. HTTP原理

>HTTP是一个==无状态==的协议。即客户端（web浏览器）和服务器之间==不需要建立持久的连接==，这意味着当一个客户端向服务端发出请求，然后服务器返回响应，连接就被关闭了，在服务器端不保留连接的有关信息。HTTP遵循==请求/响应模型==。客户端向服务器发送请求，服务器处理请求并返回适当的应答。所有HTTP连接都被构造成了一套请求和应答。

##### 4.1 传输流程

>**（1）地址解析**
>
>如果客户端浏览器请求这个页面：http://localhost.com:8080/index.htm ，解析得到的结果如下：
>
>- ==协议名==：http
>- ==主机名==：localhost
>- ==端口==：8080
>- ==对象路径==：/index.htm
>
>在这一步，需要域名系统DNS解析域名localhost.com，得主机的ip地址。

>**（2）封装HTTP请求数据包**
>
>把以上部分结合本机自己的信息，封装成一个HTTP请求数据包

>**（3）封装TCP包并建立连接**
>
>TCP三次握手

>**（4）客户机发送请求命令**
>
>建立连接后，客户端发送一个请求给服务器，请求方法的格式为：统一资源标识符URL、协议版本号，后边是MIME信息包括请求修饰符、客户机信息和内容。
>
>**（5）服务器响应**
>
>服务器接收到请求后，给予相应的响应信息，其格式为一个状态行，包括信息的协议版本号、一个成功或错误的代码，后边是MIME信息包括服务信息、实体信息和可能的内容。
>
>**（6）服务器关闭TCP连接**
>
>一般情况下，一旦web服务器向浏览器发送了请求数据，它就要关闭TCP连接，然后如果浏览器或者服务器在其头信息加入了这行代码Connection:keep-alive，TCP连接在发送后将仍然保持打开状态，于是，浏览器可以继续通过相同的连接发送请求。保持连接节省了为每个请求建立新连接所需的时间，还节约了网络带宽。
>
><img src="https://tva1.sinaimg.cn/large/008eGmZEgy1gn4a1c5cvij31480nggot.jpg" style="zoom:60%">

##### 4.2 HTTPS

>`Hypertext Transfer Protocol over Secure Socket Layer`。以安全为目标的HTTP通道。即==HTTP下加入SSL层==，HTTPS的安全基础是SSL。其所用的==端口号是443==。
>
>过程如下：
>
>**（1）建立连接获取证书**
>
>SSL客户端通过TCP和服务器建立连接后（443端口），并且在一般的==tcp连接协商（握手）过程中请求证书==。即客户端发出一个消息给服务器，这个消息里面包含了自己可实现的算法列表和其它一些需要的消息，SSL 的服务器端会回应一个数据包，这里面确定了这次通信所需要的算法，然后服务器向客户端返回证书。（证书里面包含了服务器信息：==域名==。==申请证书的公司==，==公共秘钥==）。
>
>**（2）证书验证**
>
>客户端在收到服务器返回的证书后，判断签发这个证书的公共签发机构，并使用这个机构的公共秘钥确认签名是否有效，客户端还会确保证书中列出的域名就是它正在连接的域名。
>
>**（3）数据加密和传输**
>
>如果确认证书有效，那么生成对称秘钥并使用服务器的公共秘钥进行加密。然后发送给服务器，服务器使用它的私钥对它进行解密，这样两台计算机可以开始进行对称加密进行通信。
>
><img src="https://tva1.sinaimg.cn/large/008eGmZEgy1gn4afqscqaj30ny0r6417.jpg" style="zoom:50%">

#### 5. CDN原理

>`Content Delivery Network`——内容分发网络。
>
>CDN一般包含==分发服务系统==、==负载均衡系统==和==管理系统==。

##### 5.1 分发服务系统

>其基本的工作单元就会各个Cache服务器。负责直接响应用户请求，将内容快速分发到用户；同时还负责内容更新，保证和源站内容的同步。
>
>根据内容类型和服务种类的不同，分发服务系统分为多个子服务系统，如：==网页加速服务==、==流媒体加速服务==、==应用加速服务==等。每个子服务系统都是一个分布式的服务集群，由功能类似、地域接近的分布部署的 Cache 集群组成。
>
>在承担内容同步、更新和响应用户请求之外，分发服务系统还需要向上层的管理调度系统反馈各个Cache 设备的健康状况、响应情况、内容缓存状况等，以便管理调度系统能够根据设定的策略决定由哪个 Cache 设备来响应用户的请求。

##### 5.2 负载均衡系统

>负载均衡系统是整个 CDN 系统的中枢。负责对所有的用户请求进行调度，确定提供给用户的最终访问地址。
>
>使用分级实现。最基本的两极调度体系包括全局负载均衡（GSLB）和本地负载均衡（SLB）。
>
>- GSLB 根据用户地址和用户请求的内容，主要根据==就近性原则，确定向用户服务的节点。一般通过 DNS解析或者应用层重定向（Http 3XX 重定向）的方式实现==。
>
>- SLB 主要负责节点内部的负载均衡。当用户请求从 GSLB 调度到 SLB 时，SLB 会根据节点内各个Cache 设备的工作状况和内容分布情况等对用户请求重定向。==SLB 的实现有四层调度（LVS）、七层调度（Nginx）和链路负载调度等==。

##### 5.3 管理系统

>分为运营管理和网络管理子系统。
>
>网络管理系统实现对 CDN 系统的设备管理、拓扑管理、链路监控和故障管理，为管理员提供对全网资源的可视化的集中管理，通常用 web 方式实现。
>
>运营管理是对 CDN 系统的业务管理，负责处理业务层面的与外界系统交互所必须的一些收集、整理、交付工作。包括用户管理、产品管理、计费管理、统计分析等。

