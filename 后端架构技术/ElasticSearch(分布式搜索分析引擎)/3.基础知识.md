#### 1. 基本概念

##### 1.1 索引（index）

>- 索引是ES对逻辑数据的==逻辑存储==，所以它可以分为更小的部分。
>- 可以把索引看成关系型数据库的表，索引的结构是==为全文索引准备==的，特别是它==不存储原始值==。
>- ES可以把索引存放在一台机器或者分散在多台服务器上，==每个索引有一或多个分片==，==每个分片有多个副本==。
>
>例如：可以有一个客户信息的索引，包括一个产品目录的索引，一个订单数据的索引。在系统上索引的名字全部小写，通过这个名字可以用来执行索引、搜索、更新和删除操作等。在单个集群中，可以定义多个你想要的索引。
>
><img src="https://tva1.sinaimg.cn/large/0081Kckwgy1glhm23n1ltj30qy0hygp0.jpg" style="zoom:60%">

##### 1.2 文档（document）

>- 存储在ES中的主要==实体==叫文档（document）。用关系型数据库来类比的话，==一个文档相当于数据库表中的一行记录==。
>- 文档可以有不同的结构，但==相同字段必须有相同类型==。
>- 文档由多个字段组成，==每个字段可能多次出现在一个文档里==，这样的字段叫多值字段（multivalued）。
>- 每个字段的类型，可以是文本、数值、日期等。字段类型也可以是复杂类型，一个字段包含其他子文档或者数组。
>
>==文档是存储在ES中的一个JSON格式的字符串==。每个存储在索引中的一个文档都有一个类型和一个ID，每个文档存储了零个或者多个字段，或者键值对。原始的JSON文档被存储在一个叫作`_source`的字段中。当搜索文档时默认返回的就是这个字段。

##### 1.3 映射（mapping）

>文档写进索引之前都会先进行分析，如何将输入的文本分割为词条、哪些词条又会被过滤，这种行为叫做映射（mapping）。一般由用户自己定义规则。
>
>映射像关系型数据库中的表结构，每一个索引都有一个映射，它==定义了索引中的每一个字段类型==，以及一个索引范围内的设置。一个映射可以事先被定义，或者在第一次存储文档的时候自动识别。

##### 1.4 文档类型（type）

>- 在索引中，可以定义一个或多个类型，==类型是索引的逻辑分区==。
>- 在一般情况下，*<u>一种类型被定义为具有一组公共字段的文档</u>*。
>- 例如，让我们假设你运行一个博客平台，并把所有的数据存储在一个索引中。在这个索引中，你可以定义一种类型为用户数据，一种类型为博客数据，另一种类型为评论数据。

#### 2. ES 术语及概念

##### 1.1 索引词（term）

>- 在ES中索引词（term）是一个能够被索引的精确值。
>- foo、Foo、FOO几个单词是不同的索引词。
>- 索引词可以通过term查询进行准确的搜索。

##### 1.2 文本（text）

>- 文本是一段普通的非结构化文字。
>- 通常文本会被分析成一个个的索引词，存储在ES的索引库中。
>- 为了让文本能够进行搜索，文本字段需要事先进行分析；
>- 当对文本中的关键词进行查询的时候，搜索引擎应该根据搜索条件搜索出原文本。

##### 1.3 分析（analysis）

>分析是将文本转换为索引词的过程，分析的结果依赖于分词器。
>
>比如：FOO BAR、Foo-Bar和foo bar这几个单词有可能会被分析成相同的索引词foo和bar，这些索引词存储在ES的索引库中。当用FoO:bAR进行全文搜索的时候，搜索引擎根据匹配计算也能在索引库中搜索出之前的内容。

##### 1.4 集群（cluster）

>- 集群有一个或多个节点组成，对外提供服务，*<u>对外提供索引和搜索功能</u>*。
>- 在所有节点，一个集群有一个唯一的名称默认为“Elasticsearch”。此名称是很重要的，因为每个节点只能是集群的一部分，当该节点被设置为相同的集群名称时，就会自动加入集群。*<u>当需要有多个集群的时候，要确保每个集群的名称不能重复</u>*，否则，节点可能会加入错误的集群。
>- 请注意，一个节点只能加入一个集群。
>- 此外，你还可以拥有多个独立的集群，每个集群都能其不同的集群名称。例如，在开发过程中，你可以建立开发集群库和测试集群库，分别为开发、测试服务。
>
>ES集群结构如下图：
>
><img src="https://tva1.sinaimg.cn/large/0081Kckwgy1glhc3uraetj30qm0j2q5w.jpg" style="zoom:50%">

##### 1.5 节点（node）

>- 一个节点是一个逻辑上独立的服务，它是集群的一部分，可以存储数据，并参与集群的索引和搜索功能。
>- 就像集群一样，*<u>节点也有唯一的名字，在启动的时候分配</u>*。如果你不想要默认名称，可以定义任何想要的节点名。这个名字在管理中很重要，*<u>在网络中ES集群通过节点名称进行管理和通信</u>*。
>- 一个节点可以被配置加入一个特定的集群。*<u>默认情况下，每个节点会加入名为Elasticsearch的集群中，这意味着如果你在网络上启动多个节点，如果网络畅通，它们能彼此发现并自动加入一个名为Elasticsearch的集群中</u>*。
>- 在一个集群中，你可以拥有多个你想要的节点。当网络没有集群运行的时候，只要启动任何一个节点，这个节点会默认生成一个新的集群，这个集群会有一个节点。

##### 1.6 路由（routing）

>- *<u>当存储一个文档的时候，它会存储在唯一的主分片中，具体哪个分片是通过散列值进行选择</u>*。
>- 默认情况下，散列值是由文档的ID生成。如果文档有一个指定的父文档，则从父文档ID中生成，该值可以在存储文档的时候进行修改。

##### 1.7 分片（shard）

>- *<u>分片是单个Lucene实例</u>*，这是ES管理的比较底层的功能。
>- 索引是执行主分片和副分片的逻辑空间。
>- 对于使用，只需要知道分片的数量，其他不需要做过多的事情。
>- 在开发使用的过程中，我们对应的对象都是索引，ES会自动管理集群中的所有的分片，当发生故障的时候，ES会把分片移动到不同的节点或者添加新的节点。
>
>一个索引可以存储很大的数据，这些空间可以超过一个节点的物理存储的限制。例如，十亿个文档占用磁盘空间为1TB。仅从单个节点搜索可能会很慢，还有一台物理机器也不一定能存储这么多的数据，为了解决这一问题，*<u>ES将索引分解成多个分片。当你创建一个索引，你可以简单地定义你想要的分片数量。每个分片本身是一个全功能的、独立的单元，可以托管在集群中的任何节点</u>*。

##### 1.8 主分片（primary shard）

>- 每个文档都存储在一个分片中，当你存储一个文档的时候，*<u>系统会首先存储在主分片中，然后会复制到不同的副本中</u>*。
>- 默认情况下，一个索引有5个主分片。你可以实现定制分片的数量，当分片一旦建立，则分片的数量不能修改。

##### 1.9 副本分片（replica shard）

>每一个分片有零个或多个副本。副本主要是主分片的复制，有两个目的：
>
>1. **增加高可用性**：当主分片失败的时候，可以从副本分片中选择一个作为主分片。
>2. **提高性能**：当查询的时候可以到主分片或副本分片中进行查询。默认情况下，一个主分片配有一个副本，但副本的数量可以在后面动态地配置增加。*<u>副本分片必须部署在不同的节点上，不能部署在和主分片相同的节点上</u>*。
>
>分片主要有两个很重要的原因：
>
>1. **允许水平分割扩展数据**
>2. **允许分配和并行操作**（可能在多个节点上）：提高性能和吞吐量。
>
>这些功能对用户来说都是透明的，无需操作，系统会自动处理。

##### 1.10 复制（replica）

>复制是一个非常有用的功能，不然会有单点问题。*<u>当网络中的某个节点出现问题的时候，复制可以对故障进行转移，保证系统的高可用</u>*。ES允许你创建一个或对个拷贝，你的索引分片就形成了所谓的副本或副本分片。

>复制的优点：
>
>- 高可用性，当节点失败的时候不受影响。一个复制的分片不会存储在同一个节点中。
>- 扩展搜索量，提高并发量，因为搜索可以在所有副本上并行执行。

>每个所有可以拆分成多个分片。*<u>索引可以复制零个或多个分片。一旦复制，每个索引就有了主分片和副本分片</u>*。分片的数量和副本的数量可以在创建索引时定义。创建索引后，可以随时改变副本的数量，但不能改变分片的数量。
>
>- ==默认情况下，每个索引分配5个分片和一个副本，即你的集群节点至少要有两个节点，你将拥有5个主要的分片和5个副本分片，共计10个分片==。

>Tips：每个ES分片是一个Lucene的索引。有文档存储数量限制，你可以在一个单一的Lucene索引中存储的最大值为lucene-5843，极限是 2147483519（=Integer.max_value - 128）

##### 1.11 字段（field）

>文档中包含零个或者多个字段，字段可以是一个简单的值（例如字符串、整数、日期），也可以是一个数组或对象的嵌套结构。字段类似于关系数据库中表的列。每个字段都对应一个字段类型。字段还可以指定如何分析该字段的值。

##### 1.12 来源字段（source field）

>默认情况下，你的原文档将被存储在_source这个字段中，当你查询的时候也是返回这个字段。这允许你可以从搜索结果中访问原始的对象，这个对象返回一个精确的JSON字符串，这个对象不显示索引分析后的其他任何数据。

##### 1.13 主键（ID）

>ID是一个文件的唯一标识，如果在存库的时候没有提供ID，系统会自动生成一个ID，文档的index/type/id必须是唯一的。

#### 3. JSON介绍

>在ES中的接口中，大多数都是以JSON的格式进行的。
>
>JavaScript Object Notation是一种轻量级的数据交换格式。
>
>JSON有两种结构：
>
>1. “名称/值”对的集合。不同的语言中的理解不同，如对象(object)、记录(record)、结构(struct)、字典(dictionary)、哈希表(hash table)、有键列表或者关联数组。
>
>```json
>{"firstName":"Brett","lastName":"McLaughlin","email":"aaaa"}
>```
>
>2. 值的有序列表。在大部分语言中，是指数组(array)。
>
>```json
>{
>    "people":[		{"firstName":"Brett","lastName":"McLaughlin","email":"aaaa"},        {"firstName":"Jason","lastName":"Hunter","email":"bbbb"},    {"firstName":"Elliotte","lastName":"Harold","email":"cccc"}
>    ]
>}
>```

