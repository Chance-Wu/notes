#### 1. 重复消息

---

消息重复的两个原因：①生产时消息重复 ②消费时消息重复

##### 1.1 生产时消息重复

> 由于生产者发送消息给MQ，==在MQ确认的时候出现网络波动，生产者没有收到确认，实际上MQ已经接收到消息。这时候生产者就会重新发送一遍这条消息==。
>
> 生产者中如果消息未被确认，或确认失败，可以使用定时任务+（redis/db）来进行消息重试。

##### 1.2 消费时消息重复

>消费者消费成功后，再给MQ确认的时候出现网络波动，MQ没有接收到消息确认，为了保证消息被消费，MQ就会继续给消费者投递之前的消息。这时候消费者就接收到了两条一样的消息。

>注意：==由于重复消息是由于网络原因造成的，因此不可避免重复消息。但是我们需要保证消息的幂等性==。



#### 2. 如何保证消息的幂等性

---

让每个消息携带一个全局唯一ID，即可保证消息的幂等性，具体消费过程为：

1. 消费者获取到消息后先根据id去查询redis/db是否存在该消息
2. 如果不存在，则正常消费，消费完毕后写入redis/db
3. 如果存在，则证明消息被消费过，直接丢弃。

